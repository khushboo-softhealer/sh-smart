<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- SALE ORDER RECURRING FORM VIEW -->
    <record id="sh_sale_recurring_form_view" model="ir.ui.view">
        <field name="name">sh.sale.recurring.form.view</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="create_order_manually" type="object" string="Create Order Manually" class="oe_highlight" attrs="{'invisible':[('state','!=','confirm')]}" />

                    <button name="active_sr" string="Active" type="object" attrs="{'invisible': [('active', '=', True)]}" />
                    <button name="archive_sr" string="Archive" type="object" attrs="{'invisible': [('active', '=', False)]}" />

                    <field name="state" widget="statusbar" options="{'clickable': '1'}" />
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" name="action_view_recurring_quote" type="object" icon="fa-file-text-o" attrs="{'invisible': [('sh_quote_recurring_count', '=', 0)]}">
                            <field string="Quotations" name="sh_quote_recurring_count" widget="statinfo" />
                        </button>
                        <button class="oe_stat_button" name="action_view_recurring_order" type="object" icon="fa-file-text" attrs="{'invisible': [('sh_sale_recurring_count', '=', 0)]}">
                            <field string="Sales Orders" name="sh_sale_recurring_count" widget="statinfo" />
                        </button>
                        <button class="oe_stat_button" name="action_view_invoices" type="object" icon="fa-pencil-square-o" attrs="{'invisible': [('sh_invoice_count', '=', 0)]}">
                            <field string="Invoices" name="sh_invoice_count" widget="statinfo" />
                        </button>
                    </div>
                    <widget name="web_ribbon" title="Archived" bg_color="bg-danger" attrs="{'invisible': [('active', '=', True)]}" />
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1" />
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="active" invisible="1" />
                            <field name="company_id" invisible="1" />
                            <field name="online_signature" invisible="1" />
                            <field name="title" attrs="{'readonly':[('state','!=','draft')]}" />
                            <field name="partner_id" widget="res_partner_many2one" attrs="{'readonly':[('state','not in',['draft'])]}" context="{'res_partner_search_mode': 'customer', 'show_address': 1, 'show_vat': True}" options='{"always_reload": True}' />
                            <field name="start_date" attrs="{'readonly':[('state','!=','draft')]}" widget="remaining_days" options="{'allow_order': '1'}" />
                            <field name="last_generated_date" invisible="1" />
                            <field name="partner_invoice_id"/>
                            <field name="partner_shipping_id"/>
                            <field name="sale_order_template_id"/>
                            <field name="odoo_version"/>
                            <field name="timeline"/>
                            <field name="estimated_hrs"/>
                            <field name="sh_edition_id"/>
                            <field name="is_sh_confirm_sale"/>
                            <field name="sh_is_download_module_mail_sent"/>
                            <field name="sh_move_task_to_preapp_store"/>
                        </group>

                        <group>
                            <label for="recurring_interval" />
                            <div class="o_row" name="wage">
                                <field name="recurring_interval" nolabel="1" attrs="{'readonly':[('state','!=','draft')]}" />
                                <span>
                                    <field name="recurring_interval_unit" nolabel="1" attrs="{'readonly':[('state','!=','draft')]}" />
                                </span>
                            </div>

                            <label for="stop_recurring_interval" />
                            <div class="o_row" name="wage">
                                <field name="stop_recurring_interval" nolabel="1" attrs="{'readonly':[('state','!=','draft')]}" />
                                <span>
                                    <field name="stop_recurring_interval_unit" nolabel="1" />
                                </span>
                            </div>

                            <label for="end_date" widget="remaining_days" options="{'allow_order': '1'}" />
                            <div class="o_row">
                                <field name="end_date" nolabel="1" attrs="{'readonly':[('state','!=','draft')]}" />
                                <span class="text-muted">(If fixed-term contract)</span>
                            </div>
                            <field name="pricelist_id"/>
                            <field name="payment_term_id"/>
<!--                            <field name="project_id"/>-->
                            <field name="project_manager"/>
                            <field name="po_ref"/>
                            <field name="sh_replied_status_id"/>
                            <field name="sh_sale_ticket_ids" widget="many2many_tags"/>
                            <field name="responsible_user_id"/>
                            <field name="sh_task_id"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Order Lines">
                            <field name="order_line" attrs="{'readonly':[('state','!=','draft')]}" widget="section_and_note_one2many">
                                <form string="Quotation Template Lines">
                                <!--
                                    We need the sequence field to be here for new lines to be added at the correct position.
                                    TODO: at some point we want to fix this in the framework so that an invisible field is not required.
                                -->
<!--                                <field name="sequence" invisible="1"/>-->
                                <field name="display_type" invisible="1"/>
                                <notebook colspan="4" name="description">
                                    <page string="Description" name="order_description" attrs="{'invisible': [('display_type', '!=', False)]}">
                                        <field name="name" />
                                    </page>
                                    <page string="Section" name="order_section" attrs="{'invisible': [('display_type', '!=', 'line_section')]}">
                                        <field name="name" />
                                    </page>
                                    <page string="Note" name="order_note" attrs="{'invisible': [('display_type', '!=', 'line_note')]}">
                                        <field name="name" />
                                    </page>
                                </notebook>
                            </form>
                                <tree editable="bottom">
                                    <control>
                                        <create name="add_product_control" string="Add a product"/>
                                        <create name="add_section_control" string="Add a section" context="{'default_display_type': 'line_section'}"/>
                                        <create name="add_note_control" string="Add a note" context="{'default_display_type': 'line_note'}"/>
                                    </control>
                                    <field name="display_type" invisible="1"/>
                                    <field name="company_id" invisible="1" />
                                    <field name="product_id" force_save="1" />
                                    <field name="name" />
                                    <field name="analytic_distribution" widget="analytic_distribution" options="{'product_field': 'product_id', 'business_domain': 'sale_order'}"/>
                                    <field name="product_uom_qty" />
                                    <field name="price_unit" />
                                    <field name="discount" groups="product.group_discount_per_so_line" />
                                    <button icon='fa-bars' name="btn_add_detail_estimation" type="object" class="oe_highlight" title="Add Detail Estimation"/>
                                </tree>
                            </field>
                        </page>
                        <page name="internal_notes" string="Internal Notes">
                            <field name="note" placeholder="Internal note..." attrs="{'readonly':[('state','!=','draft')]}" />
                        </page>
                        <!--attrs="{'invisible':[('online_signature','=',False)]}"-->
                        <page string="Other Info">
                            <group>
                            <group name="sales_person" string="Sales">
                                <field name="user_id" widget="many2one_avatar_user"/>
                                <field name="team_id" kanban_view_ref="%(sales_team.crm_team_view_kanban)s" options="{'no_create': True}"/>
                                <field name="company_id" options="{'no_create': True}" groups="base.group_multi_company"/>
                                <label for="require_signature" string="Online confirmation"/>
                                <div>
                                    <field name="require_signature" class="oe_inline"/>
                                    <span>Signature</span>
                                    <field name="require_payment" class="oe_inline ms-3"/>
                                    <span>Payment</span>
                                </div>
                            </group>
                            <group string="Signature Information">
                                <group>
                                    <field name="signed_by" />
                                    <field name="signed_on" />
                                    <field name="signature" widget="image" />
                                </group>
                            </group>
                            </group>
                        </page>
                        <page name="project_details" string="Project Details">
                    <group>
                        <group>
                            <!-- Approx Planned Date -->
                            <label for="sh_planned_date_from" string="Approx Planned Date"/>
                            <div class="o_row">
                                <field name="sh_planned_date_from" class="oe_inline" />
                                <span class="text-muted">To</span>
                                <field name="sh_planned_date_to" />
                            </div>
                            <field name="sh_total_work_duration" />
                        </group>
                        <group>
                            <field name="sh_project_stage_tmpl_id" />
                            <!-- Pricing Mode -->
                            <field name="sh_pricing_mode"/>
                            <field name="sh_fp_based_on" attrs="{'invisible': [('sh_pricing_mode', '!=', 'fp')], 'required': [('sh_pricing_mode', '=', 'fp')]}" />
                            <field name="sh_tm_based_on" attrs="{'invisible': [('sh_pricing_mode', '!=', 'tm')], 'required': [('sh_pricing_mode', '=', 'tm')]}" />
                        </group>
                    </group>
                </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" />
                    <field name="activity_ids" />
                    <field name="message_ids" />
                </div>
            </form>
        </field>
    </record>

    <!-- sale recurring tree view -->
    <record id="sh_sale_recurring_tree_view" model="ir.ui.view">
        <field name="name">sale.order.tree</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <tree sample="1" multi_edit="1">
                <field name="name" readonly="1" decoration-bf="1" />
                <field name="partner_id" optional="show" />
                <field name="start_date" widget="remaining_days" options="{'allow_order': '1'}" optional="show" />
                <field name="end_date" widget="remaining_days" options="{'allow_order': '1'}" optional="show" />
                <field name="activity_ids" widget="list_activity" optional="show" />
                <field name="last_generated_date" optional="hide" widget="remaining_days" options="{'allow_order': '1'}" />
                <field name="company_id" optional="hide" />
                <field name="sh_sale_recurring_count" optional="show" />
                <field name="state" decoration-danger="state in ['cancel','done']" decoration-info="state in ['draft']" decoration-success="state in ['confirm']" decoration-primary="state in ['pending']" widget="badge" optional="show" />
            </tree>
        </field>
    </record>

    <!-- action to Renew-->
    <record model="ir.actions.server" id="action_to_renew">
        <field name="name">To Renew</field>
        <field name="model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            action = records.action_to_renew()
        </field>
    </record>
    <!-- action In process-->
    <record model="ir.actions.server" id="action_in_process">
        <field name="name">In process</field>
        <field name="model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            action = records.action_in_process()
        </field>
    </record>
    <!-- action Expired-->
    <record model="ir.actions.server" id="action_expired">
        <field name="name">Expired</field>
        <field name="model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_model_id" ref="sh_sale_order_recurring.model_sale_recurring" />
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
            action = records.action_expired()
        </field>
    </record>

    <record model="ir.ui.view" id="view_sale_recurring_order_kanban">
        <field name="name">sale.recurring.order.kanban</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" sample="1">
                <field name="name" />
                <field name="partner_id" />
                <field name="last_generated_date" />
                <field name="state" />
                <field name="activity_state" />
                <progressbar field="activity_state" colors='{"planned": "success", "today": "warning", "overdue": "danger"}' />
                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                            <div class="o_kanban_record_top mb16">
                                <div class="o_kanban_record_headings mt4">
                                    <strong class="o_kanban_record_title">
                                        <span>
                                            <t t-esc="record.partner_id.value" />
                                        </span>
                                    </strong>
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom">
                                <div class="oe_kanban_bottom_left text-muted">
                                    <span>
                                        <t t-esc="record.name.value" />
                                        <t t-esc="record.last_generated_date.value" />
                                    </span>
                                    <field name="activity_ids" widget="kanban_activity" />
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <field name="state" widget="label_selection" options="{'classes': {'draft': 'default', 'cancel': 'default', 'done': 'success'}}" />
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>
    <record id="view_sale_recurring_order_calendar" model="ir.ui.view">
        <field name="name">sale.recurring.order.calendar</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <calendar string="Sales Recurring Orders" date_start="last_generated_date" color="state" hide_time="true" event_limit="5">
                <field name="partner_id" avatar_field="avatar_128" />
                <field name="state" filters="1" invisible="1" />
            </calendar>
        </field>
    </record>
    <record id="sale_recurring_order_view_activity" model="ir.ui.view">
        <field name="name">sale.recurring.order.activity</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <activity string="Sales Recurring Orders">
                <templates>
                    <div t-name="activity-box">
                        <div>
                            <field name="name" display="full" />
                            <field name="partner_id" muted="1" display="full" />
                        </div>
                    </div>
                </templates>
            </activity>
        </field>
    </record>
    <!-- SALE RECURRING SEARCH VIEW -->
    <record id="sh_sale_recurring_search_view" model="ir.ui.view">
        <field name="name">sh.sale.recurring.search.view</field>
        <field name="model">sale.recurring</field>
        <field name="arch" type="xml">
            <search string="Search recurring Order">
                <field name="name" string="Recurring Order" filter_domain="['|',('name','ilike',self),('partner_id','child_of',self)]" />
                <field name="partner_id" operator="child_of" />

                <filter string="Active" domain="[('active','=',True)]" name="sh_recurring_active" />
                <filter string="Inactive" domain="[('active','=',False)]" name="sh_recurring_inactive" />

                <filter string="New" domain="[('state','=','draft')]" name="filter_new" />
                <filter string="Running" domain="[('state','=','confirm')]" name="filter_confirm" />
                <filter string="To Renew" domain="[('state','=','pending')]" name="filter_pending" />
                <filter string="Expired" domain="[('state','=','done')]" name="filter_done" />
                <filter string="Cancelled" domain="[('state','=','cancel')]" name="filter_cancel" />
                <filter string="Start Date" name="filter_start_dt" date="start_date" />
                <filter string="End Date" name="filter_end_dt" date="end_date" />

                <group expand="0" string="Group By">
                    <filter name="customer_gb" string="Customer" domain="[]" context="{'group_by':'partner_id'}" />
                    <filter name="start_date_gb" string="Start Date" domain="[]" context="{'group_by':'start_date'}" />
                    <filter name="end_date_gb" string="End Date" domain="[]" context="{'group_by':'end_date'}" />
                    <filter name="state_gb" string="Status" domain="[]" context="{'group_by':'state'}" />
                </group>
            </search>
        </field>
    </record>

    <!-- SALE RECURRING ACTION -->
    <record id="sh_sale_recurring_action" model="ir.actions.act_window">
        <field name="name">Sale Recurring Order</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.recurring</field>
        <field name="view_mode">tree,kanban,calendar,activity,form</field>
        <field name="context">{ 'search_default_sh_recurring_active' : True }</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Create a new sale recurring order here
            </p>
        </field>
    </record>

    <!-- SALE RECURRING ORDER MENU -->
    <menuitem id="sh_sale_recurring_order_menu" name="Recurring Orders" sequence="50" action="sh_sale_recurring_action" parent="sale.sale_order_menu" groups="sales_team.group_sale_salesman" />

</odoo>